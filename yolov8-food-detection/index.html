<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"roubin.me","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="本文旨在梳理并总结项目过程，方便后续回顾查阅。 部分预测结果：">
<meta property="og:type" content="article">
<meta property="og:title" content="基于YOLOv8的菜品检测项目">
<meta property="og:url" content="https://roubin.me/yolov8-food-detection/index.html">
<meta property="og:site_name" content="CV肉饼王">
<meta property="og:description" content="本文旨在梳理并总结项目过程，方便后续回顾查阅。 部分预测结果：">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://roubin.me/images/food_detection.jpg">
<meta property="og:image" content="https://roubin.me/images/yolov8_package_counting.gif">
<meta property="og:image" content="https://roubin.me/images/yolov8_fish_counting.gif">
<meta property="og:image" content="https://roubin.me/images/yolov8_people_counting.gif">
<meta property="og:image" content="https://roubin.me/images/yolov8_speed_estimate.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_car_scratch.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_data_preview.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_data_category.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_data_mismatch.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_data_issue.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_exif_1.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_exif_2.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_exif_3.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_exif_4.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_exif_match.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_category_num.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_data_format1.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_data_format.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_roboflow.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_intro.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_task.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_models.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_coco_dir.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_loss.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_data_aug.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_hyper_tune.png">
<meta property="og:image" content="https://roubin.me/images/yolov8_final_compare.png">
<meta property="og:image" content="https://roubin.me/images/food_detection.jpg">
<meta property="article:published_time" content="2024-03-22T03:18:14.000Z">
<meta property="article:modified_time" content="2024-10-26T07:38:32.047Z">
<meta property="article:author" content="roubin">
<meta property="article:tag" content="yolo">
<meta property="article:tag" content="目标检测">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://roubin.me/images/food_detection.jpg">

<link rel="canonical" href="https://roubin.me/yolov8-food-detection/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>基于YOLOv8的菜品检测项目 | CV肉饼王</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b55ece62ebeb2e72a8efe3f8b5b43960";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CV肉饼王</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Talk is cheap. Show me the code.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://roubin.me/yolov8-food-detection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="roubin">
      <meta itemprop="description" content="芝兰其室，金石其心<br/>仁义为友，道德为师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CV肉饼王">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          基于YOLOv8的菜品检测项目
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-03-22 11:18:14" itemprop="dateCreated datePublished" datetime="2024-03-22T11:18:14+08:00">2024-03-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-10-26 15:38:32" itemprop="dateModified" datetime="2024-10-26T15:38:32+08:00">2024-10-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CV/" itemprop="url" rel="index"><span itemprop="name">CV</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/yolov8-food-detection/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="yolov8-food-detection/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>19 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>本文旨在梳理并总结项目过程，方便后续回顾查阅。</p>
<p>部分预测结果：<br><img src="https://roubin.me/images/food_detection.jpg" alt=""></p>
<a id="more"></a>
<h3 id="一、目标检测的应用场景"><a href="#一、目标检测的应用场景" class="headerlink" title="一、目标检测的应用场景"></a>一、目标检测的应用场景</h3><p>基于深度学习的目标检测，目前在各个领域都有广泛的应用场景，可以归纳为以下几类：</p>
<ul>
<li>交通领域：智能驾驶、智能交通、行人跟踪、车辆检测</li>
<li>工业领域：瑕疵检测、裂缝检测、归类检测、智能农业</li>
<li>商业领域：直播检测、商品检测、文本检测</li>
<li>医学领域：细胞检测、病灶检测</li>
</ul>
<p><img src="../images/yolov8_package_counting.gif" alt="Conveyor Belt Packets Counting"></p>
<p><img src="../images/yolov8_fish_counting.gif" alt="Fish Counting in Sea"></p>
<p><img src="../images/yolov8_people_counting.gif" alt="People Counting in Different Region"></p>
<p><img src="../images/yolov8_speed_estimate.png" alt="Speed Estimation on Road"></p>
<p><img src="../images/yolov8_car_scratch.png" alt="car scratch detection"></p>
<h3 id="二、项目描述"><a href="#二、项目描述" class="headerlink" title="二、项目描述"></a>二、项目描述</h3><h4 id="1-任务描述"><a href="#1-任务描述" class="headerlink" title="1.任务描述"></a>1.任务描述</h4><ul>
<li>基于YOLOv8和自定义数据集UNIMIB2016，对pretrained model进行fine tune来添加新的类别（意大利菜），从而实现对菜品的识别检测</li>
<li>使用 W&amp;B sweep 进行 hyperparameter tune（超参数调优），来进一步优化模型性能</li>
</ul>
<h4 id="2-数据集"><a href="#2-数据集" class="headerlink" title="2.数据集"></a>2.数据集</h4><p><img src="../images/yolov8_data_preview.png" alt=""><br>使用的数据集来源于 <a href="http://www.ivl.disco.unimib.it/activities/food-recognition/" target="_blank" rel="noopener">UNIMIB2016 Food Database</a>，数据集在一家真实的意大利餐厅中收集而来，每张照片的尺寸为 (3264, 2448)，包含一个托盘和托盘上不同的食物。</p>
<p><img src="../images/yolov8_data_category.png" alt=""><br>一共有1027张照片，共计73种菜品，总计3616个菜品实例。一些种类的食物只是在成分上有所不同，所以命名为“FoodName 1”, “FoodName 2”。</p>
<p>因为菜品原文是意大利语，我用AI对其进行了翻译，大致中文译名如下：</p>
<table>
<thead>
<tr>
<th>编号</th>
<th>意大利语</th>
<th>中文翻译</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>pane</td>
<td>面包</td>
</tr>
<tr>
<td>1</td>
<td>mandarini</td>
<td>橘子</td>
</tr>
<tr>
<td>2</td>
<td>carote</td>
<td>胡萝卜</td>
</tr>
<tr>
<td>3</td>
<td>patate/pure</td>
<td>土豆/土豆泥</td>
</tr>
<tr>
<td>4</td>
<td>cotoletta</td>
<td>炸肉排</td>
</tr>
<tr>
<td>5</td>
<td>fagiolini</td>
<td>青豆</td>
</tr>
<tr>
<td>6</td>
<td>yogurt</td>
<td>酸奶</td>
</tr>
<tr>
<td>7</td>
<td>budino</td>
<td>布丁</td>
</tr>
<tr>
<td>8</td>
<td>spinaci</td>
<td>菠菜</td>
</tr>
<tr>
<td>9</td>
<td>scaloppine</td>
<td>薄切肉片</td>
</tr>
<tr>
<td>10</td>
<td>pizza</td>
<td>披萨</td>
</tr>
<tr>
<td>11</td>
<td>pasta_sugo_vegetariano</td>
<td>素食酱汁意大利面</td>
</tr>
<tr>
<td>12</td>
<td>mele</td>
<td>苹果</td>
</tr>
<tr>
<td>13</td>
<td>pasta_pesto_besciamella_e_cornetti</td>
<td>香蒜酱白酱意大利面和羊角面��</td>
</tr>
<tr>
<td>14</td>
<td>zucchine_umido</td>
<td>炖西葫芦</td>
</tr>
<tr>
<td>15</td>
<td>lasagna_alla_bolognese</td>
<td>博洛尼亚千层面</td>
</tr>
<tr>
<td>16</td>
<td>arancia</td>
<td>橙子</td>
</tr>
<tr>
<td>17</td>
<td>pasta_sugo_pesce</td>
<td>海鲜酱汁意大利面</td>
</tr>
<tr>
<td>18</td>
<td>patatine_fritte</td>
<td>炸薯条</td>
</tr>
<tr>
<td>19</td>
<td>pasta_cozze_e_vongole</td>
<td>贻贝和蛤蜊意大利面</td>
</tr>
<tr>
<td>20</td>
<td>arrosto</td>
<td>烤肉</td>
</tr>
<tr>
<td>21</td>
<td>riso_bianco</td>
<td>白米饭</td>
</tr>
<tr>
<td>22</td>
<td>medaglioni_di_carne</td>
<td>肉丸</td>
</tr>
<tr>
<td>23</td>
<td>torta_salata_spinaci_e_ricotta</td>
<td>菠菜和羊乳酪馅饼</td>
</tr>
<tr>
<td>24</td>
<td>pasta_zafferano_e_piselli</td>
<td>藏红花和豌豆意大利面</td>
</tr>
<tr>
<td>25</td>
<td>patate/pure_prosciutto</td>
<td>土豆/土豆泥配火腿</td>
</tr>
<tr>
<td>26</td>
<td>torta_salata_rustica_(zucchine)</td>
<td>乡村馅饼（西葫芦）</td>
</tr>
<tr>
<td>27</td>
<td>insalata_mista</td>
<td>混合沙拉</td>
</tr>
<tr>
<td>28</td>
<td>pasta_mare_e_monti</td>
<td>海陆意大利面</td>
</tr>
<tr>
<td>29</td>
<td>polpette_di_carne</td>
<td>肉丸</td>
</tr>
<tr>
<td>30</td>
<td>pasta_pancetta_e_zucchine</td>
<td>意大利熏肉和西葫芦意大利面</td>
</tr>
<tr>
<td>31</td>
<td>pasta_ricotta_e_salsiccia</td>
<td>羊乳酪和香肠意大利面</td>
</tr>
<tr>
<td>32</td>
<td>orecchiette_(ragu)</td>
<td>意大利小耳面（肉酱）</td>
</tr>
<tr>
<td>33</td>
<td>pizzoccheri</td>
<td>荞麦面疙瘩</td>
</tr>
<tr>
<td>34</td>
<td>finocchi_gratinati</td>
<td>烤茴香</td>
</tr>
<tr>
<td>35</td>
<td>pere</td>
<td>梨</td>
</tr>
<tr>
<td>36</td>
<td>pasta_tonno</td>
<td>金枪鱼意大利面</td>
</tr>
<tr>
<td>37</td>
<td>riso_sugo</td>
<td>米饭配酱汁</td>
</tr>
<tr>
<td>38</td>
<td>pasta_tonno_e_piselli</td>
<td>金枪鱼和豌豆意大利面</td>
</tr>
<tr>
<td>39</td>
<td>piselli</td>
<td>豌豆</td>
</tr>
<tr>
<td>40</td>
<td>torta_salata_3</td>
<td>馅饼 3</td>
</tr>
<tr>
<td>41</td>
<td>torta_salata_(alla_valdostana)</td>
<td>馅饼（瓦尔多斯坦风格）</td>
</tr>
<tr>
<td>42</td>
<td>banane</td>
<td>香蕉</td>
</tr>
<tr>
<td>43</td>
<td>salmone_(da_menu_sembra_spada_in_realta)</td>
<td>鲑鱼（菜单上看起来像剑鱼）</td>
</tr>
<tr>
<td>44</td>
<td>pesce_2_(filetto)</td>
<td>鱼 2（鱼片）</td>
</tr>
<tr>
<td>45</td>
<td>bruscitt</td>
<td>烤面包片</td>
</tr>
<tr>
<td>46</td>
<td>guazzetto_di_calamari</td>
<td>鱿鱼炖菜</td>
</tr>
<tr>
<td>47</td>
<td>pasta_e_fagioli</td>
<td>意大利面和豆子</td>
</tr>
<tr>
<td>48</td>
<td>pasta_sugo</td>
<td>意大利面配酱汁</td>
</tr>
<tr>
<td>49</td>
<td>arrosto_di_vitello</td>
<td>小牛肉烤肉</td>
</tr>
<tr>
<td>50</td>
<td>stinco_di_maiale</td>
<td>猪腿</td>
</tr>
<tr>
<td>51</td>
<td>minestra_lombarda</td>
<td>伦巴第炖菜</td>
</tr>
<tr>
<td>52</td>
<td>finocchi_in_umido</td>
<td>炖茴香</td>
</tr>
<tr>
<td>53</td>
<td>pasta_bianco</td>
<td>白面意大利面</td>
</tr>
<tr>
<td>54</td>
<td>cavolfiore</td>
<td>花椰菜</td>
</tr>
<tr>
<td>55</td>
<td>merluzzo_alle_olive</td>
<td>橄榄鳕鱼</td>
</tr>
<tr>
<td>56</td>
<td>zucchine_impanate</td>
<td>炸西葫芦</td>
</tr>
<tr>
<td>57</td>
<td>pesce_(filetto)</td>
<td>鱼（鱼片）</td>
</tr>
<tr>
<td>58</td>
<td>torta_crema_2</td>
<td>奶油蛋糕 2</td>
</tr>
<tr>
<td>59</td>
<td>roastbeef</td>
<td>烤牛肉</td>
</tr>
<tr>
<td>60</td>
<td>rosbeef</td>
<td>烤牛肉</td>
</tr>
<tr>
<td>61</td>
<td>cibo_bianco_non_identificato</td>
<td>未识别的白色食物</td>
</tr>
<tr>
<td>62</td>
<td>torta_crema</td>
<td>奶油蛋糕</td>
</tr>
<tr>
<td>63</td>
<td>passato_alla_piemontese</td>
<td>皮埃蒙特蔬菜汤</td>
</tr>
<tr>
<td>64</td>
<td>pasta_e_ceci</td>
<td>意大利面和鹰嘴豆</td>
</tr>
<tr>
<td>65</td>
<td>crema_zucca_e_fagioli</td>
<td>南瓜和豆子奶油</td>
</tr>
<tr>
<td>66</td>
<td>focaccia_bianca</td>
<td>白底油炸饼</td>
</tr>
<tr>
<td>67</td>
<td>minestra</td>
<td>汤</td>
</tr>
<tr>
<td>68</td>
<td>torta_cioccolato_e_pere</td>
<td>巧克力梨蛋糕</td>
</tr>
<tr>
<td>69</td>
<td>torta_ananas</td>
<td>菠萝蛋糕</td>
</tr>
<tr>
<td>70</td>
<td>rucola</td>
<td>火箭菜</td>
</tr>
<tr>
<td>71</td>
<td>strudel</td>
<td>德式卷饼</td>
</tr>
<tr>
<td>72</td>
<td>insalata_2_(uova_mais)</td>
<td>沙拉 2（鸡蛋和玉米）</td>
</tr>
</tbody></table>
<h4 id="3-项目环境"><a href="#3-项目环境" class="headerlink" title="3.项目环境"></a>3.项目环境</h4><table>
<thead>
<tr>
<th>Software/Hardware</th>
<th>Version</th>
</tr>
</thead>
<tbody><tr>
<td>OS</td>
<td>Linux-5.15.0-101-generic-x86_64-with-glibc2.35</td>
</tr>
<tr>
<td>Python</td>
<td>3.10.13</td>
</tr>
<tr>
<td>W&amp;B CLI Version</td>
<td>0.16.5</td>
</tr>
<tr>
<td>ultralytics</td>
<td>8.0.186</td>
</tr>
<tr>
<td>PyTorch</td>
<td>2.2.0</td>
</tr>
<tr>
<td>CUDA</td>
<td>12.1</td>
</tr>
<tr>
<td>CPU</td>
<td>E5-2696 v4</td>
</tr>
<tr>
<td>GPU</td>
<td>1 x RTX A4000</td>
</tr>
<tr>
<td>GPU Memory</td>
<td>16G</td>
</tr>
<tr>
<td>Memory</td>
<td>32G</td>
</tr>
<tr>
<td>HDD</td>
<td>80G</td>
</tr>
</tbody></table>
<h3 id="三、数据预处理"><a href="#三、数据预处理" class="headerlink" title="三、数据预处理"></a>三、数据预处理</h3><h4 id="1-标注-label-数据提取"><a href="#1-标注-label-数据提取" class="headerlink" title="1.标注(label)数据提取"></a>1.标注(label)数据提取</h4><p>原数据集中的每张图片，都有对应的label，保存在annotations.mat文件（.mat文件是Matlab的Map对象）中，需要先将其提取出来，这里我参考了<a href="https://blog.csdn.net/IYXUAN/article/details/124524700" target="_blank" rel="noopener">这篇博文</a>，代码如下：</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">% .</span></span><br><span class="line"><span class="comment">% ├── annotations.mat</span></span><br><span class="line"><span class="comment">% ├── demo.m</span></span><br><span class="line"><span class="comment">% ├── formatted_annotations</span></span><br><span class="line"><span class="comment">% │   ├── 20151127_114556.txt</span></span><br><span class="line"><span class="comment">% │   ├── 20151127_114946.txt</span></span><br><span class="line"><span class="comment">% │   ├── 20151127_115133.txt</span></span><br><span class="line"><span class="comment">% │   ├── ...</span></span><br><span class="line"><span class="comment">% │   └── 20151221_135642.txt</span></span><br><span class="line"><span class="comment">% └── load_annotations.m</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">%% load_annotations.m</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">clc; clear;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">% output path</span></span><br><span class="line">output = <span class="string">'./formatted_annotations/'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">% Load the annotations in a map structure</span></span><br><span class="line">load(<span class="string">'annotations.mat'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">% Each entry in the map corresponds to the annotations of an image.</span></span><br><span class="line"><span class="comment">% Each entry contains many cell tuples as annotated food</span></span><br><span class="line"><span class="comment">% A tuple is composed of 8 cells with the annotated:</span></span><br><span class="line"><span class="comment">% - (1) item category (food for all tuples)</span></span><br><span class="line"><span class="comment">% - (2) item class (e.g. pasta, patate, ...)</span></span><br><span class="line"><span class="comment">% - (3) item name</span></span><br><span class="line"><span class="comment">% - (4) boundary type (polygonal for all tuples)</span></span><br><span class="line"><span class="comment">% - (5) item's boundary points [x1,y1,x2,y2,...,xn,yn]</span></span><br><span class="line"><span class="comment">% - (6) item's bounding box [x1,y1,x2,y2,x3,y3,x4,y4]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">image_names = annotations.keys;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n_images = <span class="built_in">numel</span>(image_names);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">j</span> = <span class="number">1</span> : n_images</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    image_name = image_names&#123;<span class="built_in">j</span>&#125;;</span><br><span class="line">    tuples = annotations(image_name);</span><br><span class="line">    count = <span class="built_in">size</span>(tuples,<span class="number">1</span>);</span><br><span class="line">    coordinate_mat = cell2mat(tuples(:,<span class="number">6</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">% open file</span></span><br><span class="line">    file_path = [output image_name <span class="string">'.txt'</span>];</span><br><span class="line">    ffile = fopen(file_path, <span class="string">'w'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">% write file</span></span><br><span class="line">    <span class="keyword">for</span> k = <span class="number">1</span> : count</span><br><span class="line">        item = tuples(k,:);</span><br><span class="line">        fprintf(ffile, <span class="string">'%s %d %d %d %d %d %d %d %d\n'</span>, ...</span><br><span class="line">            string(item(<span class="number">2</span>)), ...  <span class="comment">% item class</span></span><br><span class="line">            coordinate_mat(k,:)); <span class="comment">% item's bounding box</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">% close file</span></span><br><span class="line">    fclose(ffile);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">%% fprintf</span></span><br><span class="line"><span class="comment">% Write data to text file</span></span><br><span class="line"><span class="comment">% https://www.mathworks.com/help/matlab/ref/fprintf.html</span></span><br></pre></td></tr></table></figure>
<p>运行上述Matlab脚本文件，在./formatted_annotations文件夹下生成以图片名命名的*.txt文件，每一行的格式为class x1 y1 x2 y2 x3 y3 x4 y4（如下所示）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">patate/pure 2000 1200 2680 1200 2680 1950 2000 1950</span><br><span class="line">pasta_mare_e_monti 843 667 1623 667 1623 1467 843 1467</span><br></pre></td></tr></table></figure>
<p>这里的x1 y1代表检测框的左上顶点，顺时针依此类推。</p>
<h4 id="2-数据集有效性检查"><a href="#2-数据集有效性检查" class="headerlink" title="2.数据集有效性检查"></a>2.数据集有效性检查</h4><p>这里主要做两个检查：</p>
<ul>
<li>图片和label是否一一对应</li>
<li>label格式是否正确（即需要按照class x1 y1 x2 y2 x3 y3 x4 y4中间用空格隔开）</li>
</ul>
<p>检查代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check_dataset.py</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># path of formatted_annotations</span></span><br><span class="line">f_path = os.path.join(os.getcwd(), <span class="string">'../source/annotations/formatted_annotations'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># path of images</span></span><br><span class="line">img_path = os.path.join(os.getcwd(), <span class="string">'../source/original'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_dataset</span><span class="params">()</span>:</span></span><br><span class="line">    annotations = [i[:<span class="number">-4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> os.listdir(f_path)]</span><br><span class="line">    imgs = [i[:<span class="number">-4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> os.listdir(img_path)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> annotation <span class="keyword">in</span> annotations:</span><br><span class="line">        label = annotation + <span class="string">'.txt'</span></span><br><span class="line">        label_path = os.path.join(f_path, label)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> annotation <span class="keyword">not</span> <span class="keyword">in</span> imgs:</span><br><span class="line">                <span class="comment"># remove annotation which is not in images</span></span><br><span class="line">                print(<span class="string">'not found image: &#123;&#125;, remove its annotation'</span>.format(annotation))</span><br><span class="line">                print(label_path)</span><br><span class="line">                <span class="comment"># 将文件名带(0)的图片重命名为annotation + '.jpg'</span></span><br><span class="line">                old_img_path = os.path.join(img_path, annotation + <span class="string">'(0).jpg'</span>)</span><br><span class="line">                new_img_path = os.path.join(img_path, annotation + <span class="string">'.jpg'</span>)</span><br><span class="line">                os.rename(old_img_path, new_img_path)</span><br><span class="line">                <span class="keyword">raise</span> FileExistsError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># check extra spaces in a line</span></span><br><span class="line">                <span class="keyword">with</span> open(label_path) <span class="keyword">as</span> f:</span><br><span class="line">                    lines = f.readlines()</span><br><span class="line">                    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">                        item = line.split()</span><br><span class="line">                        <span class="keyword">if</span> len(item) &gt; <span class="number">9</span>:</span><br><span class="line">                            print(<span class="string">'wrong label format: &#123;&#125;, &#123;&#125;'</span>.format(annotation, line))</span><br><span class="line">                            <span class="keyword">raise</span> FileExistsError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> FileExistsError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    check_dataset()</span><br></pre></td></tr></table></figure>
<p>上述代码实际已经包含了修复图片和label的功能。因为实际检查中会发现有21个label找不到对应的image（如下图）<br><img src="../images/yolov8_data_mismatch.png" alt=""></p>
<p>但仔细观察，这21张图片只是文件名后面多了个(0)，将(0)去掉后，与对应label一起显示出来，会发现数据是正常的（中间还遇到了EXIF的问题，具体过程后面再说）<br><img src="../images/yolov8_data_issue.png" alt=""></p>
<p>除了上述21张图片名有问题外，还有一个label有异常，它的格式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insalata_2_(uova mais) 1017 795 1951 795 1951 1679 1017 1679</span><br></pre></td></tr></table></figure>
<p>就是<code>uova mais</code>里多了一个空格，被判定为异常，于是我把空格用下划线替代了。</p>
<h4 id="3-EXIF问题"><a href="#3-EXIF问题" class="headerlink" title="3.EXIF问题"></a>3.EXIF问题</h4><p>这是在检查上面21张文件名异常的图片时遇到的。为了确认这21张图片只是文件名有问题，还是本身就和label不匹配，我需要将它们和label一起显示出来看看，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">label = <span class="string">'../source/valid/20151211_122610.txt'</span></span><br><span class="line">image = <span class="string">'../source/valid/20151211_122610.jpg'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">label_list = []</span><br><span class="line"><span class="keyword">with</span> open(label) <span class="keyword">as</span> file:</span><br><span class="line">    lines = file.readlines()</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        line = line.strip().split(<span class="string">' '</span>)</span><br><span class="line">        label_list.append(line)</span><br><span class="line">print(label_list)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载图片</span></span><br><span class="line">image = cv2.imread(image)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> label_list:</span><br><span class="line">    x1, y1, x2, y2, x3, y3, x4, y4 = map(int, line[<span class="number">1</span>:])</span><br><span class="line">    points = np.array([[x1, y1], [x2, y2], [x3, y3], [x4, y4]])</span><br><span class="line">    points = points.astype(np.int32)</span><br><span class="line">    cv2.polylines(image, [points], <span class="literal">True</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示图片</span></span><br><span class="line">cv2.imshow(<span class="string">'Image'</span>, image)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br><span class="line">cv2.destroyAllWindows()</span><br></pre></td></tr></table></figure>
<p>显示出来发现label和菜品对不上，但仔细观察发现，似乎把图片旋转一下就能对上了<br><img src="../images/yolov8_exif_1.png" alt="label错位"></p>
<p>在查阅了一些<a href="https://blog.csdn.net/IYXUAN/article/details/124427316" target="_blank" rel="noopener">资料</a>后，知道是EXIF信息造成的问题。简单来说，EXIF 信息就是由数码相机在拍摄过程中采集一系列的信息，然后把信息放置在我们熟知的 JPEG/TIFF 文件的头部，也就是说 Exif信息是镶嵌在 JPEG/TIFF 图像文件格式内的一组拍摄参数（如下图）<br><img src="../images/yolov8_exif_2.png" alt=""></p>
<p>其中的EXIF Orientation tag（EXIF方向参数）让你随便怎么照，在电脑上都可以看到正确方向的照片，而无需手动旋转<br><img src="../images/yolov8_exif_3.png" alt=""></p>
<p>在目标检测中，给数据集做标记的时候，是不关注图像的 EXIF Orientation tag，而图像本身是含有 EXIF Orientation tag 的，某些软件（比如cv2）在读取图片时，对其做了旋转，导致label和图片对不上，所以需要我们手动移除EXIF信息，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rectify_imgs.py</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># image type</span></span><br><span class="line">img_type = <span class="string">'.jpg'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># image folder path</span></span><br><span class="line">path = os.path.join(os.getcwd(), <span class="string">'./dataset/images'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rectify_imgs</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> img_name <span class="keyword">in</span> os.listdir(path):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> img_name[<span class="number">-4</span>:] == img_type:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        img_path = os.path.join(path, img_name)</span><br><span class="line">        image = Image.open(img_path)</span><br><span class="line">        data = list(image.getdata())</span><br><span class="line">        image_without_exif = Image.new(image.mode, image.size)</span><br><span class="line">        image_without_exif.putdata(data)</span><br><span class="line">        image_without_exif.save(img_path)</span><br><span class="line">        print(img_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    rectify_imgs()</span><br></pre></td></tr></table></figure>

<p>移除后的图片没有了EXIF信息：<br><img src="../images/yolov8_exif_4.png" alt=""></p>
<p>和label一起显示的效果，都对应上了：<br><img src="../images/yolov8_exif_match.png" alt=""></p>
<h4 id="4-类别统计"><a href="#4-类别统计" class="headerlink" title="4.类别统计"></a>4.类别统计</h4><p>主要是看一下类别分布情况，编写代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># class_count.py</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># formatted_annotations path</span></span><br><span class="line">path = os.path.join(os.getcwd(), <span class="string">'../source/annotations/formatted_annotations'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># output path</span></span><br><span class="line">output = os.path.join(os.getcwd(), <span class="string">'./class_counts_result.csv'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># read file list of formatted_annotations</span></span><br><span class="line">annotations = os.listdir(path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    labels = []</span><br><span class="line">    <span class="keyword">for</span> annotation <span class="keyword">in</span> annotations:</span><br><span class="line">        <span class="keyword">with</span> open(os.path.join(path, annotation)) <span class="keyword">as</span> file:</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> file:</span><br><span class="line">                item = line.split()</span><br><span class="line">                cls = item[<span class="number">0</span>]</span><br><span class="line">                labels.append(cls)</span><br><span class="line">    counts = pd.Series(labels).value_counts()</span><br><span class="line">    counts.to_csv(output, header=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>部分数据如下，发现类别存在分布不平衡的情况，对后续训练和检测效果会有一定影响<br><img src="../images/yolov8_category_num.png" alt=""></p>
<h4 id="5-label格式转换"><a href="#5-label格式转换" class="headerlink" title="5.label格式转换"></a>5.label格式转换</h4><p>yolov8对label格式有一些要求，如下图：<br><img src="../images/yolov8_data_format1.png" alt=""><br><img src="../images/yolov8_data_format.png" alt=""></p>
<p>解释一下：</p>
<ul>
<li>.txt中的每行代表一个物体</li>
<li>每行的格式为：类名 x中心坐标 y中心坐标 宽 高</li>
<li>数据需要做归一化（0-1之间）</li>
<li>类别以数字代替（从0开始）</li>
</ul>
<p>所以我们的label还需要做一下转换，以符合上述要求，转换代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># toYolo.py</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># formatted_annotations path</span></span><br><span class="line">path = os.path.join(os.getcwd(), <span class="string">'../source/annotations/formatted_annotations'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># path of images</span></span><br><span class="line">img_path = os.path.join(os.getcwd(), <span class="string">'../source/original'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># output path</span></span><br><span class="line">output_path = os.path.join(os.getcwd(), <span class="string">'./labels'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># class count file path</span></span><br><span class="line">class_file_path = os.path.join(os.getcwd(), <span class="string">'./class_counts_result.csv'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_box</span><span class="params">(size, box)</span>:</span></span><br><span class="line">    <span class="comment"># convert VOC to yolo format</span></span><br><span class="line">    <span class="comment"># box: [xmin, xmax, ymin, ymax]</span></span><br><span class="line">    dw, dh = <span class="number">1.</span> / size[<span class="number">0</span>], <span class="number">1.</span> / size[<span class="number">1</span>]  <span class="comment"># 归一化比例</span></span><br><span class="line">    x, y, w, h = (box[<span class="number">0</span>] + box[<span class="number">1</span>]) / <span class="number">2.0</span>, (box[<span class="number">2</span>] + box[<span class="number">3</span>]) / <span class="number">2.0</span>, box[<span class="number">1</span>] - box[<span class="number">0</span>], box[<span class="number">3</span>] - box[<span class="number">2</span>]  <span class="comment"># 中心点坐标和宽高</span></span><br><span class="line">    <span class="keyword">return</span> [x * dw, y * dh, w * dw, h * dh]  <span class="comment"># 归一化后的坐标</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_bbox</span><span class="params">(ibb)</span>:</span></span><br><span class="line">    <span class="comment"># convert ibb to VOC format</span></span><br><span class="line">    <span class="comment"># ibb = [x1,y1,x2,y2,x3,y3,x4,y4]</span></span><br><span class="line">    X = ibb[<span class="number">0</span>::<span class="number">2</span>]  <span class="comment"># [x1,x2,x3,x4]</span></span><br><span class="line">    Y = ibb[<span class="number">1</span>::<span class="number">2</span>]  <span class="comment"># [y1,y2,y3,y4]</span></span><br><span class="line">    xmin = min(X)</span><br><span class="line">    ymin = min(Y)</span><br><span class="line">    xmax = max(X)</span><br><span class="line">    ymax = max(Y)</span><br><span class="line">    <span class="keyword">return</span> xmin, ymin, xmax, ymax</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_classes</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># output: class list</span></span><br><span class="line">    cf = open(class_file_path, <span class="string">'r'</span>)</span><br><span class="line">    clss = [line.split(<span class="string">','</span>)[<span class="number">0</span>] <span class="keyword">for</span> line <span class="keyword">in</span> cf.readlines()]</span><br><span class="line">    cf.close()</span><br><span class="line">    <span class="keyword">return</span> clss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">toYolo</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># read file list of formatted_annotations</span></span><br><span class="line">    annotations = os.listdir(path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get class list</span></span><br><span class="line">    clss = get_classes()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># convert every annotation in ./formatted_annotations/ to yolo format</span></span><br><span class="line">    <span class="keyword">for</span> annotation <span class="keyword">in</span> annotations:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> open(os.path.join(path, annotation)) <span class="keyword">as</span> file, open(os.path.join(output_path, annotation), <span class="string">'w'</span>) <span class="keyword">as</span> opfile:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment"># read img</span></span><br><span class="line">            img_f_path = os.path.join(img_path, annotation[:<span class="number">-4</span>] + <span class="string">'.jpg'</span>)</span><br><span class="line">            img = Image.open(img_f_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment"># get img size</span></span><br><span class="line">            size = img.size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment"># process every item in ./formatted_annotations/*.txt</span></span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> file:</span><br><span class="line">                item = line.split(<span class="string">' '</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment"># get class num</span></span><br><span class="line">                cls = item[<span class="number">0</span>]</span><br><span class="line">                cls_num = clss.index(cls)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment"># get bbox coordinates</span></span><br><span class="line">                item_bounding_box = list(map(float, item[<span class="number">1</span>:]))</span><br><span class="line">                xmin, ymin, xmax, ymax = convert_bbox(item_bounding_box)</span><br><span class="line">                b = [xmin, xmax, ymin, ymax]</span><br><span class="line">                bb = convert_box(size, b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment"># append item to output file: ../labels/*.txt</span></span><br><span class="line">                item_str = list(map(str, [cls_num] + bb))</span><br><span class="line">                line_yolo = <span class="string">' '</span>.join(item_str)</span><br><span class="line">                opfile.write(line_yolo + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            print(annotation)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    toYolo()</span><br></pre></td></tr></table></figure>
<p>转换完后的label长这样：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3 0.7169117647058824 0.6433823529411765 0.20833333333333334 0.30637254901960786</span><br><span class="line">28 0.37775735294117646 0.43586601307189543 0.2389705882352941 0.32679738562091504</span><br></pre></td></tr></table></figure>

<h4 id="6-在Roboflow中管理dataset"><a href="#6-在Roboflow中管理dataset" class="headerlink" title="6.在Roboflow中管理dataset"></a>6.在Roboflow中管理dataset</h4><p><a href="https://roboflow.com/" target="_blank" rel="noopener">roboflow</a> 是一个专注于cv模型标注、训练和部署的ML平台，也是yolov8官方推荐的。在整个项目过程中，我觉得使用roboflow做dataset的management很方便，原因有三点：</p>
<ul>
<li>有version的概念。可以对dataset做不同操作（augmentation、split、resize），然后保存成一个version</li>
<li>根据不同条件，筛选/浏览图片和label</li>
<li>将dataset下载到各算力平台的速度很快</li>
</ul>
<p>我在准备好dataset后，将它导入roboflow，然后整体浏览下label和图片是否正常：<br><img src="../images/yolov8_roboflow.png" alt=""><br>至此，数据预处理基本就完成了。</p>
<h3 id="四、数据集准备"><a href="#四、数据集准备" class="headerlink" title="四、数据集准备"></a>四、数据集准备</h3><h4 id="1-YOLOv8-介绍"><a href="#1-YOLOv8-介绍" class="headerlink" title="1.YOLOv8 介绍"></a>1.YOLOv8 介绍</h4><p><a href="https://github.com/ultralytics/ultralytics" target="_blank" rel="noopener">YOLOv8</a> 是YOLO系列目标检测算法的一个版本，由Ultralytics公司于2023年1月10日开源发布。它在YOLOv5的基础上进行了多项改进，在速度、精度和灵活性方面都取得了显著提升。<br><img src="../images/yolov8_intro.png" alt=""></p>
<p>可用于图片分类、目标检测、图像分割、目标追踪、姿势估计<br><img src="../images/yolov8_task.png" alt=""></p>
<p>其中，用于目标检测的有5个模型（从n到x，模型参数量逐渐增大，mAP逐渐提升，但检测速度会变慢），它们都是基于COCO数据集训练的：<br><img src="../images/yolov8_models.png" alt=""></p>
<p>综合考量模型的准确度和速度，本次选用的pretrained model是YOLOv8s，搭配W&amp;B记录过程中的数据和结果。</p>
<h4 id="2-数据集划分"><a href="#2-数据集划分" class="headerlink" title="2.数据集划分"></a>2.数据集划分</h4><p>按训练集：验证集：测试集 = 7:2:1比例来划分dataset，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取images文件夹下所有图片的文件名</span></span><br><span class="line">image_dir = <span class="string">'./dataset/images'</span></span><br><span class="line">image_files = [f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(image_dir) <span class="keyword">if</span> os.path.isfile(os.path.join(image_dir, f)) <span class="keyword">and</span> f.endswith(<span class="string">'.jpg'</span>)]</span><br><span class="line">label_dir = <span class="string">'./dataset/labels'</span></span><br><span class="line">label_files = [f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(label_dir) <span class="keyword">if</span> os.path.isfile(os.path.join(label_dir, f)) <span class="keyword">and</span> f.endswith(<span class="string">'.txt'</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机打乱文件名</span></span><br><span class="line">random.shuffle(image_files)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照7:2:1的比例划分图片</span></span><br><span class="line">total = len(image_files)</span><br><span class="line">train_ratio, val_ratio = <span class="number">0.7</span>, <span class="number">0.2</span></span><br><span class="line">train_files = image_files[:int(total * train_ratio)]</span><br><span class="line">val_files = image_files[int(total * train_ratio):int(total * (train_ratio + val_ratio))]</span><br><span class="line">test_files = image_files[int(total * (train_ratio + val_ratio)):]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建目标文件夹</span></span><br><span class="line">os.makedirs(<span class="string">f'<span class="subst">&#123;image_dir&#125;</span>/train'</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">os.makedirs(<span class="string">f'<span class="subst">&#123;image_dir&#125;</span>/val'</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">os.makedirs(<span class="string">f'<span class="subst">&#123;image_dir&#125;</span>/test'</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">os.makedirs(<span class="string">f'<span class="subst">&#123;label_dir&#125;</span>/train'</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">os.makedirs(<span class="string">f'<span class="subst">&#123;label_dir&#125;</span>/val'</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">os.makedirs(<span class="string">f'<span class="subst">&#123;label_dir&#125;</span>/test'</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将图片复制到对应的文件夹下</span></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> train_files:</span><br><span class="line">    shutil.copy(os.path.join(image_dir, f), <span class="string">f'<span class="subst">&#123;image_dir&#125;</span>/train'</span>)</span><br><span class="line">    <span class="comment"># 找到同名的label_file并复制到对应的文件夹下</span></span><br><span class="line">    label_file = f.replace(<span class="string">'.jpg'</span>, <span class="string">'.txt'</span>)</span><br><span class="line">    shutil.copy(os.path.join(label_dir, label_file), <span class="string">f'<span class="subst">&#123;label_dir&#125;</span>/train'</span>)</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> val_files:</span><br><span class="line">    shutil.copy(os.path.join(image_dir, f), <span class="string">f'<span class="subst">&#123;image_dir&#125;</span>/val'</span>)</span><br><span class="line">    label_file = f.replace(<span class="string">'.jpg'</span>, <span class="string">'.txt'</span>)</span><br><span class="line">    shutil.copy(os.path.join(label_dir, label_file), <span class="string">f'<span class="subst">&#123;label_dir&#125;</span>/val'</span>)</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> test_files:</span><br><span class="line">    shutil.copy(os.path.join(image_dir, f), <span class="string">f'<span class="subst">&#123;image_dir&#125;</span>/test'</span>)</span><br><span class="line">    label_file = f.replace(<span class="string">'.jpg'</span>, <span class="string">'.txt'</span>)</span><br><span class="line">    shutil.copy(os.path.join(label_dir, label_file), <span class="string">f'<span class="subst">&#123;label_dir&#125;</span>/test'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3-文件夹结构和dataset-yaml文件"><a href="#3-文件夹结构和dataset-yaml文件" class="headerlink" title="3.文件夹结构和dataset.yaml文件"></a>3.文件夹结构和dataset.yaml文件</h4><p>YOLOv8使用自定义dataset训练时，需要编写一个dataset描述文件（<code>dataset.yaml</code>），训练启动时，程序会读取<code>dataset.yaml</code>中的配置信息，加载对应目录下的数据，所以<code>dataset.yaml</code>和实际的目录需要对应起来才能工作。</p>
<p>有如下两种目录组织方式：</p>
<h5 id="（1）coco目录格式"><a href="#（1）coco目录格式" class="headerlink" title="（1）coco目录格式"></a>（1）coco目录格式</h5><p><img src="../images/yolov8_coco_dir.png" alt=""></p>
<p>根目录是datasets，下面有一个<code>coco</code>文件夹，<code>coco</code>文件夹下分别有2个子文件夹：<code>images</code> 文件夹直接存放所有图片数据，<code>labels</code> 文件夹直接存放图片对应的*.txt标记文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── images</span><br><span class="line">│   ├── 20151127_114556.jpg</span><br><span class="line">│   ├── 20151127_114946.jpg</span><br><span class="line">│   └── 20151127_115133.jpg</span><br><span class="line">├── labels</span><br><span class="line">│   ├── 20151127_114556.txt</span><br><span class="line">│   ├── 20151127_114946.txt</span><br><span class="line">│   └── 20151127_115133.txt</span><br></pre></td></tr></table></figure>
<p>对应的dataset.yaml长这样：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yolov/data/coco.yaml</span></span><br><span class="line"><span class="attr">path:</span> <span class="string">../datasets/coco</span>  <span class="comment"># dataset root dir</span></span><br><span class="line"><span class="attr">train:</span> <span class="string">train2017.txt</span>  <span class="comment"># train images (relative to 'path')</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">val2017.txt</span>  <span class="comment"># val images</span></span><br><span class="line"><span class="attr">test:</span> <span class="string">test-dev2017.txt</span></span><br></pre></td></tr></table></figure>
<p>train2017.txt, val2017.txt,test-dev2017.txt中存放训练集、验证集、测试集的图片文件路径，其内容如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./images/20151127_114556.jpg</span><br><span class="line">./images/20151127_114946.jpg</span><br><span class="line">./images/20151127_115133.jpg</span><br></pre></td></tr></table></figure>

<h5 id="（2）coco128目录格式"><a href="#（2）coco128目录格式" class="headerlink" title="（2）coco128目录格式"></a>（2）coco128目录格式</h5><p>我用的就是这种格式，目录结构长这样：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">coco128</span><br><span class="line">├── images</span><br><span class="line">│   ├── test</span><br><span class="line">│   │   └── 20151127_115133.jpg</span><br><span class="line">│   └── train</span><br><span class="line">│       └── 20151127_114556.jpg</span><br><span class="line">└── labels</span><br><span class="line">    ├── test</span><br><span class="line">    │   └── 20151127_115133.txt</span><br><span class="line">    └── train</span><br><span class="line">        └── 20151127_114556.txt</span><br></pre></td></tr></table></figure>

<p>unimib2016.yaml（配置文件）内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Train/val/test sets as 1) dir: path/to/imgs, 2) file: path/to/imgs.txt, or 3) list: [path/to/imgs1, path/to/imgs2, ..]</span></span><br><span class="line"><span class="attr">path:</span> <span class="string">./unimib2016</span> <span class="comment"># dataset root dir</span></span><br><span class="line"><span class="attr">train:</span> <span class="string">images/train</span> <span class="comment"># train images (relative to 'path')</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">images/val</span> <span class="comment"># val images (relative to 'path')</span></span><br><span class="line"><span class="attr">test:</span> <span class="string">images/test</span> <span class="comment">#test images (optional)</span></span><br><span class="line"><span class="comment"># number of classes</span></span><br><span class="line"><span class="attr">nc:</span> <span class="number">73</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># class names ['0', '1', '2']</span></span><br><span class="line"><span class="attr">names:</span></span><br><span class="line">  <span class="attr">0:</span> <span class="string">pane</span></span><br><span class="line">  <span class="attr">1:</span> <span class="string">mandarini</span></span><br><span class="line">  <span class="attr">2:</span> <span class="string">carote</span></span><br><span class="line">  <span class="attr">3:</span> <span class="string">patate/pure</span></span><br><span class="line">  <span class="attr">4:</span> <span class="string">cotoletta</span></span><br><span class="line">  <span class="attr">5:</span> <span class="string">fagiolini</span></span><br><span class="line">  <span class="attr">6:</span> <span class="string">yogurt</span></span><br><span class="line">  <span class="attr">7:</span> <span class="string">budino</span></span><br><span class="line">  <span class="attr">8:</span> <span class="string">spinaci</span></span><br><span class="line">  <span class="attr">9:</span> <span class="string">scaloppine</span></span><br><span class="line">  <span class="attr">10:</span> <span class="string">pizza</span></span><br><span class="line">  <span class="attr">11:</span> <span class="string">pasta_sugo_vegetariano</span></span><br><span class="line">  <span class="attr">12:</span> <span class="string">mele</span></span><br><span class="line">  <span class="attr">13:</span> <span class="string">pasta_pesto_besciamella_e_cornetti</span></span><br><span class="line">  <span class="attr">14:</span> <span class="string">zucchine_umido</span></span><br><span class="line">  <span class="attr">15:</span> <span class="string">lasagna_alla_bolognese</span></span><br><span class="line">  <span class="attr">16:</span> <span class="string">arancia</span></span><br><span class="line">  <span class="attr">17:</span> <span class="string">pasta_sugo_pesce</span></span><br><span class="line">  <span class="attr">18:</span> <span class="string">patatine_fritte</span></span><br><span class="line">  <span class="attr">19:</span> <span class="string">pasta_cozze_e_vongole</span></span><br><span class="line">  <span class="attr">20:</span> <span class="string">arrosto</span></span><br><span class="line">  <span class="attr">21:</span> <span class="string">riso_bianco</span></span><br><span class="line">  <span class="attr">22:</span> <span class="string">medaglioni_di_carne</span></span><br><span class="line">  <span class="attr">23:</span> <span class="string">torta_salata_spinaci_e_ricotta</span></span><br><span class="line">  <span class="attr">24:</span> <span class="string">pasta_zafferano_e_piselli</span></span><br><span class="line">  <span class="attr">25:</span> <span class="string">patate/pure_prosciutto</span></span><br><span class="line">  <span class="attr">26:</span> <span class="string">torta_salata_rustica_(zucchine)</span></span><br><span class="line">  <span class="attr">27:</span> <span class="string">insalata_mista</span></span><br><span class="line">  <span class="attr">28:</span> <span class="string">pasta_mare_e_monti</span></span><br><span class="line">  <span class="attr">29:</span> <span class="string">polpette_di_carne</span></span><br><span class="line">  <span class="attr">30:</span> <span class="string">pasta_pancetta_e_zucchine</span></span><br><span class="line">  <span class="attr">31:</span> <span class="string">pasta_ricotta_e_salsiccia</span></span><br><span class="line">  <span class="attr">32:</span> <span class="string">orecchiette_(ragu)</span></span><br><span class="line">  <span class="attr">33:</span> <span class="string">pizzoccheri</span></span><br><span class="line">  <span class="attr">34:</span> <span class="string">finocchi_gratinati</span></span><br><span class="line">  <span class="attr">35:</span> <span class="string">pere</span></span><br><span class="line">  <span class="attr">36:</span> <span class="string">pasta_tonno</span></span><br><span class="line">  <span class="attr">37:</span> <span class="string">riso_sugo</span></span><br><span class="line">  <span class="attr">38:</span> <span class="string">pasta_tonno_e_piselli</span></span><br><span class="line">  <span class="attr">39:</span> <span class="string">piselli</span></span><br><span class="line">  <span class="attr">40:</span> <span class="string">torta_salata_3</span></span><br><span class="line">  <span class="attr">41:</span> <span class="string">torta_salata_(alla_valdostana)</span></span><br><span class="line">  <span class="attr">42:</span> <span class="string">banane</span></span><br><span class="line">  <span class="attr">43:</span> <span class="string">salmone_(da_menu_sembra_spada_in_realta)</span></span><br><span class="line">  <span class="attr">44:</span> <span class="string">pesce_2_(filetto)</span></span><br><span class="line">  <span class="attr">45:</span> <span class="string">bruscitt</span></span><br><span class="line">  <span class="attr">46:</span> <span class="string">guazzetto_di_calamari</span></span><br><span class="line">  <span class="attr">47:</span> <span class="string">pasta_e_fagioli</span></span><br><span class="line">  <span class="attr">48:</span> <span class="string">pasta_sugo</span></span><br><span class="line">  <span class="attr">49:</span> <span class="string">arrosto_di_vitello</span></span><br><span class="line">  <span class="attr">50:</span> <span class="string">stinco_di_maiale</span></span><br><span class="line">  <span class="attr">51:</span> <span class="string">minestra_lombarda</span></span><br><span class="line">  <span class="attr">52:</span> <span class="string">finocchi_in_umido</span></span><br><span class="line">  <span class="attr">53:</span> <span class="string">pasta_bianco</span></span><br><span class="line">  <span class="attr">54:</span> <span class="string">cavolfiore</span></span><br><span class="line">  <span class="attr">55:</span> <span class="string">merluzzo_alle_olive</span></span><br><span class="line">  <span class="attr">56:</span> <span class="string">zucchine_impanate</span></span><br><span class="line">  <span class="attr">57:</span> <span class="string">pesce_(filetto)</span></span><br><span class="line">  <span class="attr">58:</span> <span class="string">torta_crema_2</span></span><br><span class="line">  <span class="attr">59:</span> <span class="string">roastbeef</span></span><br><span class="line">  <span class="attr">60:</span> <span class="string">rosbeef</span></span><br><span class="line">  <span class="attr">61:</span> <span class="string">cibo_bianco_non_identificato</span></span><br><span class="line">  <span class="attr">62:</span> <span class="string">torta_crema</span></span><br><span class="line">  <span class="attr">63:</span> <span class="string">passato_alla_piemontese</span></span><br><span class="line">  <span class="attr">64:</span> <span class="string">pasta_e_ceci</span></span><br><span class="line">  <span class="attr">65:</span> <span class="string">crema_zucca_e_fagioli</span></span><br><span class="line">  <span class="attr">66:</span> <span class="string">focaccia_bianca</span></span><br><span class="line">  <span class="attr">67:</span> <span class="string">minestra</span></span><br><span class="line">  <span class="attr">68:</span> <span class="string">torta_cioccolato_e_pere</span></span><br><span class="line">  <span class="attr">69:</span> <span class="string">torta_ananas</span></span><br><span class="line">  <span class="attr">70:</span> <span class="string">rucola</span></span><br><span class="line">  <span class="attr">71:</span> <span class="string">strudel</span></span><br><span class="line">  <span class="attr">72:</span> <span class="string">insalata_2_(uova_mais)</span></span><br></pre></td></tr></table></figure>
<h3 id="五、训练与调优"><a href="#五、训练与调优" class="headerlink" title="五、训练与调优"></a>五、训练与调优</h3><h4 id="1-构建baseline-model"><a href="#1-构建baseline-model" class="headerlink" title="1.构建baseline model"></a>1.构建baseline model</h4><p>先用官方默认参数，跑一个baseline model，在此基础上，再进行提升和调优，完整的notebook代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查 GPU devices.</span></span><br><span class="line">!nvidia-smi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装包</span></span><br><span class="line">!pip install --upgrade ultralytics==<span class="number">8.0</span><span class="number">.186</span></span><br><span class="line"><span class="keyword">import</span> ultralytics</span><br><span class="line">ultralytics.checks()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看配置</span></span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> settings, YOLO</span><br><span class="line">print(settings)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载wandb</span></span><br><span class="line">!pip install wandb -qU</span><br><span class="line"><span class="keyword">import</span> wandb</span><br><span class="line">wandb.login()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化project</span></span><br><span class="line">wandb.init(project=<span class="string">"yolov8_food"</span>, job_type=<span class="string">"training"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载模型</span></span><br><span class="line">model = YOLO(<span class="string">'yolov8s.pt'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用wandb记录数据</span></span><br><span class="line"><span class="keyword">from</span> wandb.integration.ultralytics <span class="keyword">import</span> add_wandb_callback</span><br><span class="line">add_wandb_callback(model, enable_model_checkpointing=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练，先跑25轮</span></span><br><span class="line">results = model.train(project=<span class="string">"yolov8_food"</span>, data=<span class="string">'/datasets/unimib2016.yaml'</span>, epochs=<span class="number">25</span>, imgsz=<span class="number">640</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">model = YOLO(<span class="string">'./best.pt'</span>)</span><br><span class="line">metrics = model.val() </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结束记录</span></span><br><span class="line">wandb.finish()</span><br></pre></td></tr></table></figure>

<p>结果如下：<br><img src="../images/yolov8_loss.png" alt=""></p>
<h4 id="2-增加数据量"><a href="#2-增加数据量" class="headerlink" title="2.增加数据量"></a>2.增加数据量</h4><p>考虑到dataset中有73个class，图片的数量相对来说并不多，所以重新对dataset做了划分，舍弃了测试集，按训练集：验证集 = 8:2比例来重新训练，增加数据量，同时增加epoch到50</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">results = model.train(project=<span class="string">"yolov8_food"</span>, data=<span class="string">'./datasets/unimib2016.yaml'</span>, epochs=<span class="number">50</span>, imgsz=<span class="number">640</span>)</span><br></pre></td></tr></table></figure>
<p>和25epoch对比，各项指标均有所提升，但loss下降不明显，具体结果如下：<br><img src="../images/yolov8_data_aug.png" alt=""></p>
<h4 id="3-超参数调优"><a href="#3-超参数调优" class="headerlink" title="3.超参数调优"></a>3.超参数调优</h4><p>考虑使用W&amp;B的sweep进行超参数调优，进一步提升模型性能。使用起来也很方便，参数结果有直观的分析和展示，notebook代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">!pip install --upgrade ultralytics==<span class="number">8.0</span><span class="number">.186</span></span><br><span class="line"><span class="keyword">import</span> ultralytics</span><br><span class="line">ultralytics.checks()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> settings, YOLO</span><br><span class="line">print(settings)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">!pip install wandb -qU</span><br><span class="line"><span class="keyword">import</span> wandb</span><br><span class="line">wandb.login()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 参考官方文档：https://docs.ultralytics.com/usage/cfg/#train-settings</span></span><br><span class="line">sweep_config = &#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"yolov8s_random_search"</span>,</span><br><span class="line">    <span class="string">"method"</span>: <span class="string">"random"</span>,</span><br><span class="line">    <span class="string">"metric"</span>: &#123;<span class="string">"goal"</span>: <span class="string">"maximize"</span>, <span class="string">"name"</span>: <span class="string">"mAP50_95"</span>&#125;,</span><br><span class="line">    <span class="string">"parameters"</span>: &#123;</span><br><span class="line">        <span class="string">'lr0'</span>: &#123;<span class="string">'distribution'</span>: <span class="string">'uniform'</span>, <span class="string">'min'</span>: <span class="number">0</span>, <span class="string">'max'</span>: <span class="number">0.015</span>&#125;,</span><br><span class="line">        <span class="string">'lrf'</span>: &#123;<span class="string">'distribution'</span>: <span class="string">'uniform'</span>, <span class="string">'min'</span>: <span class="number">0</span>, <span class="string">'max'</span>: <span class="number">0.015</span>&#125;,</span><br><span class="line">        <span class="string">"batch"</span>: &#123;<span class="string">"values"</span>: [<span class="number">8</span>, <span class="number">16</span>]&#125;,</span><br><span class="line">        <span class="string">"epochs"</span>: &#123;<span class="string">"value"</span>: <span class="number">10</span>&#125;,</span><br><span class="line">        <span class="string">'imgsz'</span>: &#123;<span class="string">'value'</span>: <span class="number">640</span>&#125;,</span><br><span class="line">        <span class="string">"optimizer"</span>: &#123;<span class="string">"values"</span>: [<span class="string">"Adam"</span>, <span class="string">"AdamW"</span>]&#125;,</span><br><span class="line">        <span class="string">'momentum'</span>: &#123;<span class="string">'distribution'</span>: <span class="string">'uniform'</span>, <span class="string">'min'</span>: <span class="number">0.6</span>, <span class="string">'max'</span>: <span class="number">0.98</span>&#125;,</span><br><span class="line">        <span class="string">'weight_decay'</span>: &#123;<span class="string">'distribution'</span>: <span class="string">'uniform'</span>, <span class="string">'min'</span>: <span class="number">4e-4</span>, <span class="string">'max'</span>: <span class="number">5e-4</span>&#125;,</span><br><span class="line">        <span class="string">'warmup_epochs'</span>: &#123;<span class="string">'value'</span>: <span class="number">3</span>&#125;,</span><br><span class="line">        <span class="string">'warmup_momentum'</span>: &#123;<span class="string">'value'</span>: <span class="number">0.8</span>&#125;,</span><br><span class="line">        <span class="string">'warmup_bias_lr'</span>: &#123;<span class="string">'value'</span>: <span class="number">0.1</span>&#125;,</span><br><span class="line">        <span class="string">'box'</span>: &#123;<span class="string">'distribution'</span>: <span class="string">'uniform'</span>, <span class="string">'min'</span>: <span class="number">0.045</span>, <span class="string">'max'</span>: <span class="number">8.5</span>&#125;,</span><br><span class="line">        <span class="string">'cls'</span>: &#123;<span class="string">'value'</span>: <span class="number">0.5</span>&#125;,</span><br><span class="line">        <span class="string">'dfl'</span>: &#123;<span class="string">'distribution'</span>: <span class="string">'uniform'</span>, <span class="string">'min'</span>: <span class="number">0</span>, <span class="string">'max'</span>: <span class="number">2</span>&#125;,</span><br><span class="line">        <span class="string">'nbs'</span>: &#123;<span class="string">'value'</span>: <span class="number">64</span>&#125;,</span><br><span class="line">        <span class="string">'hsv_h'</span>: &#123;<span class="string">'value'</span>: <span class="number">0.015</span>&#125;,</span><br><span class="line">        <span class="string">'hsv_s'</span>: &#123;<span class="string">'value'</span>: <span class="number">0.7</span>&#125;,</span><br><span class="line">        <span class="string">'hsv_v'</span>: &#123;<span class="string">'value'</span>: <span class="number">0.4</span>&#125;,</span><br><span class="line">        <span class="string">"close_mosaic"</span>: &#123;<span class="string">"value"</span>: <span class="number">0</span>&#125;,</span><br><span class="line">        <span class="string">"mosaic"</span>: &#123;<span class="string">"value"</span>: <span class="number">1.0</span>&#125;,</span><br><span class="line">        <span class="string">"degrees"</span>: &#123;<span class="string">'distribution'</span>: <span class="string">'uniform'</span>, <span class="string">'min'</span>: <span class="number">0</span>, <span class="string">'max'</span>: <span class="number">180</span>&#125;,</span><br><span class="line">        <span class="string">"flipud"</span>: &#123;<span class="string">'distribution'</span>: <span class="string">'uniform'</span>, <span class="string">'min'</span>: <span class="number">0.0</span>, <span class="string">'max'</span>: <span class="number">0.7</span>&#125;,</span><br><span class="line">        <span class="string">"fliplr"</span>: &#123;<span class="string">'distribution'</span>: <span class="string">'uniform'</span>, <span class="string">'min'</span>: <span class="number">0.0</span>, <span class="string">'max'</span>: <span class="number">0.7</span>&#125;,</span><br><span class="line">        <span class="string">"mixup"</span>: &#123;<span class="string">'distribution'</span>: <span class="string">'uniform'</span>, <span class="string">'min'</span>: <span class="number">0.0</span>, <span class="string">'max'</span>: <span class="number">0.7</span>&#125;,</span><br><span class="line">        <span class="string">"translate"</span>: &#123;<span class="string">'distribution'</span>: <span class="string">'uniform'</span>, <span class="string">'min'</span>: <span class="number">0.0</span>, <span class="string">'max'</span>: <span class="number">0.7</span>&#125;,</span><br><span class="line">        <span class="string">"copy_paste"</span>: &#123;<span class="string">'value'</span>: <span class="number">0.0</span>&#125;,</span><br><span class="line">        <span class="string">"scale"</span>: &#123;<span class="string">'value'</span>: <span class="number">0.5</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sweep_id = wandb.sweep(sweep=sweep_config, project=<span class="string">"yolov8_food"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    wandb.init(project=<span class="string">"yolov8_food"</span>, job_type=<span class="string">"training"</span>)</span><br><span class="line">    config = wandb.config</span><br><span class="line">    model = YOLO(<span class="string">'yolov8s.pt'</span>)</span><br><span class="line">    results = model.train(project=<span class="string">"yolov8_food"</span>, data=<span class="string">'./datasets/unimib2016.yaml'</span>, **config, seed=<span class="number">42</span>, plots=<span class="literal">False</span>, save=<span class="literal">False</span>, val=<span class="literal">True</span>)</span><br><span class="line">    mAP50_95 = results.results_dict[<span class="string">'metrics/mAP50-95(B)'</span>]</span><br><span class="line">    mAP50 = results.results_dict[<span class="string">'metrics/mAP50(B)'</span>]</span><br><span class="line">    precision = results.results_dict[<span class="string">'metrics/precision(B)'</span>]</span><br><span class="line">    recall = results.results_dict[<span class="string">'metrics/recall(B)'</span>]</span><br><span class="line">    wandb.log(&#123;<span class="string">"mAP50_95"</span>: mAP50_95, <span class="string">"mAP50"</span>: mAP50, <span class="string">"precision"</span>: precision, <span class="string">"recall"</span>: recall&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wandb.agent(sweep_id, function=main, count=<span class="number">40</span>)</span><br></pre></td></tr></table></figure>
<p>以mAP50-90为评估指标，使用随机搜索，跑40组参数组合，每个组合跑8个epoch，用时大概3h，最终结果如下：<br><img src="../images/yolov8_hyper_tune.png" alt=""></p>
<p>然后选取sweep-19的这组超参数，重新训练50个epoch，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">results = model.train(project=<span class="string">"yolov8_food"</span>, data=<span class="string">'./datasets/unimib2016.yaml'</span>, epochs=<span class="number">50</span>, imgsz=<span class="number">640</span>, batch=<span class="number">8</span>, box=<span class="number">2.285159746664883</span>, cls=<span class="number">0.5</span>, copy_paste=<span class="number">0</span>,degrees=<span class="number">7.264354980360233</span>,dfl=<span class="number">1.2742635530219004</span>,fliplr=<span class="number">0.46688928408226266</span>,flipud=<span class="number">0.05092823462093257</span>,hsv_h=<span class="number">0.015</span>,hsv_s=<span class="number">0.7</span>,hsv_v=<span class="number">0.4</span>,lr0=<span class="number">0.0006620608428909274</span>,lrf=<span class="number">0.01497033032001488</span>,mixup=<span class="number">0.19795652459646865</span>,momentum=<span class="number">0.6595923950852437</span>,mosaic=<span class="number">1</span>,nbs=<span class="number">64</span>,optimizer=<span class="string">"Adam"</span>,scale=<span class="number">0.5</span>,translate=<span class="number">0.2671635746059477</span>,warmup_bias_lr=<span class="number">0.1</span>,warmup_epochs=<span class="number">3</span>,warmup_momentum=<span class="number">0.8</span>,weight_decay=<span class="number">0.0004662556589982582</span>)</span><br></pre></td></tr></table></figure>
<p>和之前的25/50epoch对比，precision有小幅提升，loss下降更多，结果如下：<br><img src="../images/yolov8_final_compare.png" alt=""></p>
<p>部分预测结果：<br><img src="https://roubin.me/images/food_detection.jpg" alt=""></p>
<h3 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h3><h4 id="1-遇到的问题"><a href="#1-遇到的问题" class="headerlink" title="1.遇到的问题"></a>1.遇到的问题</h4><p><strong>(1) error: Dataset ‘dataset/unimib2016.yaml’ images not found, missing path ‘/Users/robin/Git/tedu-ml/dataset/images/val’</strong><br>答：一开始目录结构没设置正确，和yaml配置文件对不上，调整之后解决了。</p>
<p><strong>(2) error: No labels found in /path/train.cache</strong><br>答：拷贝数据时，一部分label拷贝错了目录，结果和image没有对应上，训练开始时报了这个错。重新把label拷贝对了就好了。</p>
<p><strong>(3) warning: Corrupt JPEG data: premature end of data segment … Corrupt JPEG data: 4 extraneous bytes before marker 0xd9</strong><br>答：在自己的Mac M1上训练时遇到的，网上查了下<a href="https://github.com/ultralytics/yolov5/issues/916" target="_blank" rel="noopener">资料</a>，和底层c++库有关，后来换到算力平台上用linux没再遇到，怀疑是去除EXIF信息时造成的。</p>
<p><strong>(4) error: libGL.so.1: cannot open shared object file</strong><br>答：原因1是某些算力平台缺乏一些基础library，可以尝试<code>apt-get install -y libgl1-mesa-dev</code>重新安装一下解决。原因2是opencv版本存在冲突，卸载opencv后尝试<code>pip install opencv-python-headless</code>解决。</p>
<h4 id="2-反思"><a href="#2-反思" class="headerlink" title="2.反思"></a>2.反思</h4><p>整个过程大概花费了一周，大部分时间都用在了数据预处理和调参上，基本一个run跑完都要2～3h，比想象中慢多了</p>
<p>超参数调优的结果没有想象中那么明显，一是数据的问题，存在数据量不大、类别不均衡；二是官方本身有一组默认超参数，也是经过反复优化得到的，自己调的不一定有官方的好，当然还有s模型本身的局限性</p>
<p>训练完成的模型，其实还可以拿来做视频实时检测，但要找一个和训练图片很相似的视频不容易，所以暂时没弄</p>
<p>模型部署的部分，本来也想弄的，但碍于时间和实用性（意大利菜不常见），后续考虑训练其他数据集来尝试</p>
<h4 id="3-可以改进的地方"><a href="#3-可以改进的地方" class="headerlink" title="3.可以改进的地方"></a>3.可以改进的地方</h4><ul>
<li>增加数据量：收集更多图片和标注数据。YOLOv8模型实际上是有默认做data augmentation的，但如果图片不多的话，再怎么增强效果也不会明显</li>
<li>更好模型：比如YOLOv8m，当然前提是要考虑到部署后的推理速度。目前基于Transformer的DETR在目标检测领域效果也非常好，可以试试</li>
<li>更换参数搜索方式：比如使用贝叶斯搜索等</li>
</ul>
<p>W&amp;B详细报告：<a href="https://wandb.ai/wangbinxp/yolov8_food/reports/-YOLOv8---Vmlldzo3MzEwOTE4?accessToken=uq09cnk2aei7x4669t03bnwsgrk53v00gf0fvbm80w7jb52gt7isyym17xy4thu4" target="_blank" rel="noopener">基于YOLOv8的菜品检测项目</a></p>
<blockquote>
<p>版权声明：本文为博主原创文章，转载请注明作者和出处<br>作者：CV肉饼王<br>链接：<a href="https://roubin.me/yolov8-food-detection/">https://roubin.me/yolov8-food-detection/</a></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/yolo/" rel="tag"><i class="fa fa-tag"></i> yolo</a>
              <a href="/tags/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/" rel="tag"><i class="fa fa-tag"></i> 目标检测</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/object-detection-faster-rcnn/" rel="prev" title="目标检测之Faster R-CNN原理">
      <i class="fa fa-chevron-left"></i> 目标检测之Faster R-CNN原理
    </a></div>
      <div class="post-nav-item">
    <a href="/yolov8-onnxruntime-web-deploy/" rel="next" title="基于ONNX的Web端YOLOv8模型部署与推理">
      基于ONNX的Web端YOLOv8模型部署与推理 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#一、目标检测的应用场景"><span class="nav-text">一、目标检测的应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二、项目描述"><span class="nav-text">二、项目描述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-任务描述"><span class="nav-text">1.任务描述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-数据集"><span class="nav-text">2.数据集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-项目环境"><span class="nav-text">3.项目环境</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三、数据预处理"><span class="nav-text">三、数据预处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-标注-label-数据提取"><span class="nav-text">1.标注(label)数据提取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-数据集有效性检查"><span class="nav-text">2.数据集有效性检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-EXIF问题"><span class="nav-text">3.EXIF问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-类别统计"><span class="nav-text">4.类别统计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-label格式转换"><span class="nav-text">5.label格式转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-在Roboflow中管理dataset"><span class="nav-text">6.在Roboflow中管理dataset</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四、数据集准备"><span class="nav-text">四、数据集准备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-YOLOv8-介绍"><span class="nav-text">1.YOLOv8 介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-数据集划分"><span class="nav-text">2.数据集划分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-文件夹结构和dataset-yaml文件"><span class="nav-text">3.文件夹结构和dataset.yaml文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#（1）coco目录格式"><span class="nav-text">（1）coco目录格式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#（2）coco128目录格式"><span class="nav-text">（2）coco128目录格式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#五、训练与调优"><span class="nav-text">五、训练与调优</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-构建baseline-model"><span class="nav-text">1.构建baseline model</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-增加数据量"><span class="nav-text">2.增加数据量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-超参数调优"><span class="nav-text">3.超参数调优</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#六、总结"><span class="nav-text">六、总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-遇到的问题"><span class="nav-text">1.遇到的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-反思"><span class="nav-text">2.反思</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-可以改进的地方"><span class="nav-text">3.可以改进的地方</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="roubin"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">roubin</p>
  <div class="site-description" itemprop="description">芝兰其室，金石其心<br/>仁义为友，道德为师</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">146</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">89</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/satorioh" title="GitHub → https://github.com/satorioh" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wangbinxp@gmail.com" title="E-Mail → mailto:wangbinxp@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">roubin</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://roubinme.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://roubin.me/yolov8-food-detection/";
    this.page.identifier = "yolov8-food-detection/";
    this.page.title = "基于YOLOv8的菜品检测项目";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://roubinme.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
